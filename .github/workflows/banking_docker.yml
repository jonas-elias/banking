name: CI with Docker

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Install JQ Tool
        uses: mbround18/install-jq@v1

      - name: Run Docker container
        run: |
          cp .env.example .env
          docker compose up -d
          docker ps -a
          sleep 10

      - name: Run migrations
        run: |
          docker exec -it banking /bin/bash
          php bin/hyperf.php migrate:fresh
          exit

      - name: Debug Docker logs
        run: docker compose logs

      - name: Run Integration Tests
        run: |
          BASE_URL="http://localhost:9501/api"

          echo "Testing merchant user creation..."
          merchant_id=$(curl -X POST "$BASE_URL/user" \
            -H "Content-Type: application/json" \
            -d '{"name": "merchant","email": "merchant@gmail.com","password": "12345678","balance": 100,"type": "merchant","document": "10101010101010"}' \
            -s | jq -r '.user')

          if [ -z "$merchant_id" ]; then
            echo "Failed to create merchant user"
            exit 1
          fi

          echo "Merchant ID: $merchant_id"

          echo "Testing customer user creation..."
          common_id=$(curl -X POST "$BASE_URL/user" \
            -H "Content-Type: application/json" \
            -d '{"name": "common","email": "common@gmail.com","password": "12345678","balance": 100,"type": "common","document": "10101010101"}' \
            -s | jq -r '.user')

          if [ -z "$common_id" ]; then
            echo "Failed to create customer user"
            exit 1
          fi

          echo "Common ID: $common_id"

          echo "Testing transaction creation..."
          response_code=$(curl -X POST "$BASE_URL/transfer" \
            -H "Content-Type: application/json" \
            -d '{"payer": "'$common_id'", "payee": "'$merchant_id'", "value": 10}' \
            -o /dev/null -s -w "%{http_code}")

          if [ "$response_code" -ne 204 ]; then
            echo "Failed to create transaction (HTTP code $response_code)"
            exit 1
          fi

          echo "Transaction created successfully"
